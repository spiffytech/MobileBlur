{{$isSocial := .isSocial}}
{{$feed := .feed}}

{{define "header1"}}
    {{.feed.Title}}
    <input type="button" id="markStoriesRead" class="button" value="Mark Selected Read">
    <input type="button" id="checkAll" class="button" value="Select All">
{{end}}

{{if .notAJAX}}
    {{template "header" .}}
{{end}}

{{if .notAJAX}}
    <form name="markStoriesRead" action="/stories/markReadBulk?isSocial={{.isSocial}}" method="post">
        <div id="stories" class="row"></div>
    </form>
{{else}}
    {{$pageID := .page}}

    {{with .Stories}}
        {{range .}}
            {{if showStory .}}
                {{$score := .Score}}
                <div id="{{.ID}}" class="story score-{{$score}} story-page-{{$pageID}} {{if .ReadStatus}}{{else}}unread{{end}}" {{if $isSocial}}data-story-feed-id="{{.StoryFeedID}}"{{end}}>
                    <div class="row">
                        <div class="small-7 columns opener">
                            <h3 class="title">{{.Title}}</h3>
                        </div>
                        <div class="small-3 columns pubdate opener">
                            {{.PrettyDate}}
                        </div>
                        <div class="small-2 columns">
                            {{$hash := .HashStory}}
                            <a href="#" data-dropdown="drop-{{$hash}}" class="button tiny dropdown">Gear</a>
                            <ul id="drop-{{$hash}}" class="f-dropdown">
                                <li><a class="markUnread" data-story="story-{{if $isSocial}}{{.StoryFeedID}}{{else}}{{$feed.ID}}{{end}}-{{.ID}}" href="#">Mark Unread</a></li>
                            </ul>

                            <input type="checkbox" name='story-{{$feed.ID}}-{{if $isSocial}}{{.StoryFeedID}}-{{end}}{{.ID}}'>
                        </div>
                    </div>
                    <div class="row content"></div>
                </div>
            {{end}}
        {{end}}
    {{end}}
    <script type="text/javascript">
        jQuery(".story-page-{{$pageID}} .content").hide();
    </script>
{{end}}

{{define "scripts"}}
    <script type="text/javascript">
        jQuery(document).ready(function() {
            jQuery(window).scrollAppend({
                url: "/{{if .isSocial}}social{{else}}feeds{{end}}/{{.feed.ID}}",
                params: {},
                appendTo: "#stories",
                footerClass: "#footer",
                disableCache: true,
                pagesToPause: 5
            });

            jQuery(document).on("click", ".story .opener", function() {
                var that = jQuery(this).parents(".story");
                that.removeClass("unread");

                jQuery.get(
                    "/stories/getContent",
                    {
                        "feedID": {{.feed.ID}},
                        {{if .isSocial}}"storyFeedID": that.attr("data-story-feed-id"),{{end}}
                        "isSocial": {{if .isSocial}}true{{else}}false{{end}},
                        "storyID": that.attr("id")
                    },
                    function(data) {
                        jQuery(that).find(".content").html(data["content"]);
                    },
                    "json"
                );


                jQuery.get(
                    "/stories/mark_read",
                    {
                        "feed_id": {{.feed.ID}},
                        {{if .isSocial}}"storyFeedID": that.attr("data-story-feed-id"),{{end}}
                        "story_id": that.attr("id")
                    },
                    function() {
                        jQuery(that).removeClass("unread");
                    }
                );

                jQuery(".story .content").hide();
                that.find(".content").show();
            });

            jQuery("#checkAll").on("click", function() {
                jQuery("form[name=markStoriesRead] input[type=checkbox]").attr("checked", true);
            });

            jQuery("#markStoriesRead").on("click", function() {
                var data = jQuery("form[name=markStoriesRead]").serialize();
                jQuery.post(
                    jQuery("form[name=markStoriesRead]").attr("action"),
                    data,
                    function(data) {
                        jQuery("form[name=markStoriesRead] input:checked").removeClass("unread");
                        jQuery("form[name=markStoriesRead] input:checked").attr(checked, false);
                    }
                );
            });
            jQuery(document).on("click", "a.markUnread", function() {
                var that = this;
                jQuery.post(
                    "/stories/markUnread",
                    {"story": jQuery(this).attr("data-story")},
                    function(data) {
                        jQuery(that).parents(".story").addClass("unread");
                    }
                );
            });
        });
    </script>
{{end}}

{{if .notAJAX}}
    {{template "footer" .}}
{{end}}
